2017-Apr-21 - dev meeting
=========================

### env_module

- problem...

    Installing a python2 virtual-environment installs _both_ an `activate` file and an `activate_this.py` file. But python3 only installs an `activate` file.

    The reason that's a problem is because there are two main ways we commonly run django -- one manually, via `python ./manage.py COMMAND`, and one automatically, when apache responds to a url by handing the request off (via `passenger`) to the django python code. For python2, the manual method has utilized the `activate` file, and the passenger method has utilized the `activate_this.py` file.

    Accessing each of these files performs two functions: (1) it 'loads' the virtual environment (so that the webapp can access the packages installed into the virtual-environment), and (2) it sets the environmental-variables that the webapp needs.

    So the problem: when switching to python3, how to have passenger perform those two functions without the `activate_this.py` file?

- solution...

    - activating the virtual-environment...

        This can be done in the passenger config file by adding the `PassengerPython` specification to the project's entry:

            <Location /project_url_segment>
                PassengerFriendlyErrorPages on  # dev only!
                PassengerBaseURI /project_url_segment
                PassengerStartupFile passenger_wsgi.py
                PassengerAppType wsgi
                PassengerAppRoot /path/to/project/config

                PassengerPython /path/to/env_project/bin/python

            </Location>

        I had actually begun using this in my recent python2 projects, so this was an easy solution.

    - loading the environmental variables...

        For python2, I only need to set one environmental variable in the `activate_this.py` file -- the path to the env_var_settins.sh file. Code in my webapp's `passenger.wsgi` file ([python2 example](https://github.com/Brown-University-Library/iip/blob/93e8ed7d28dc48eeefefe72a34a20d7f51b1f1a6/iip_config/passenger_wsgi.py#L28-L33)) accesses this path, then loads the environmental-variables for the webapp.

        For python3, without the `activate_this.py` file, the solution was again via adding an entry to the project's passenger config entry:

            <Location /project_url_segment>
                PassengerFriendlyErrorPages on  # dev only!
                PassengerBaseURI /project_url_segment
                PassengerStartupFile passenger_wsgi.py
                PassengerAppType wsgi
                PassengerAppRoot /path/to/project/config
                PassengerPython /path/to/env_project/bin/python

                SetEnv ENV_VAR /path/to/env_settings/project_env_settings/env_settings.sh

            </Location>

        ...and all works. ([python3 passenger.wsgi example](https://github.com/birkin/ts_reporting_project/blob/master/config/passenger_wsgi.py)) The environmental variable is scoped to the specific project, avoiding naming-conflict concernts.

        __Note__: this requires that apache's `env_module` is set to be loaded in `httpd.conf` -- fortunately, that appears to be the default case!

            #LoadModule log_forensic_module libexec/apache2/mod_log_forensic.so
            #LoadModule logio_module libexec/apache2/mod_logio.so
            LoadModule env_module libexec/apache2/mod_env.so
            #LoadModule mime_magic_module libexec/apache2/mod_mime_magic.so
            #LoadModule expires_module libexec/apache2/mod_expires.so

---
