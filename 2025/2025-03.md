2025-March-276-Thursday - code-sharing
======================================

## auto-updater

- [github-link](https://github.com/Brown-University-Library/requirements-auto-updater)

### interesting things...

- Implements a style I like -- to have the dundermain short, [just getting args][args] (maybe also validating them), and quickly sending the args to the [main-runner-function][main].

[args]: <https://github.com/Brown-University-Library/requirements-auto-updater/blob/b13f3db861d4fea4f8719f7ab10a697de5eae22d/auto_updater.py#L304-L317>

[main]: <https://github.com/Brown-University-Library/requirements-auto-updater/blob/b13f3db861d4fea4f8719f7ab10a697de5eae22d/auto_updater.py#L214>

- Normally I try to keep the main-runner-function be a short manager, to get, at a glance, the overall flow of an app. But there are a lot of steps here, so I made the decision to allow the manager function to get long -- but kept the principle of making each step no more than 2 or 3 lines of code, by calling helpers.
    - I guess I _could_ call a "sub-manager" function for the "environmental-check" section, etc.

- Note the lib_git_handler.py file ([link][git_handler_link]). There's a _lot_ of duplication in those functions.
    - that's because of an interesting issue I came across... there are multiple ways of calling subprocess to execute a command. I was originally using a try/except technique that'd fail if the command didn't return a returncode of zero. But it turned out that, IIRC, some commands "failed" on the returncode, but the text-info indicated all was ok -- and vice-versa. So over time I began changing them all to:
        - not raise an Exception on a fail return-code, and
        - return both an "ok" indicator, as well as the captured output. _(Note the [inverse-logic][ilogic] of what the boolean would be if it represented the return-code vs "ok")_ I then handle the result in the caller function.
    - Now that they're all so similar, I still could at least have all these functions act as 'callers' to a single-function doing [this work](https://github.com/Brown-University-Library/requirements-auto-updater/blob/6e8b540ad1a6f389e115f2cfb364751380b94f58/lib/lib_git_handler.py#L13-L17).

[git_handler_link]: <https://github.com/Brown-University-Library/requirements-auto-updater/blob/main/lib/lib_git_handler.py>

[ilogic]: <https://github.com/Brown-University-Library/requirements-auto-updater/blob/main/lib/lib_git_handler.py#L15>

- I've noted before that because our webapps have slightly different architectures, I had a decision to make: either make all webapps conform to a standard set of expectations, or handle the differences in the auto-updater. I chose the former. Some advantages to this:
    - it simplifies the auto-update script
    - it allows this script (or others) to alert us when failed-expectation-conditions are detected. Many of the `## ::: run environmental checks :::` validations act as programmatic quality-control checks.

- normally a venv has to be made "active", by being sourced, before the venv can be updated from the compiled `.txt' file. [This explanation](https://github.com/Brown-University-Library/requirements-auto-updater/blob/6e8b540ad1a6f389e115f2cfb364751380b94f58/auto_updater.py#L128-L136) describes how the venv is updated programmatically.

- I just noticed, going through this code, that errors in the `uv pip sync` and `touch` commands do not trigger admin-emails on failure, and have [made an issue](https://github.com/Brown-University-Library/requirements-auto-updater/issues/12).

- The art of programming: I built this out as needed, and see some possibilities for refactoring. An example... I pass things like "project_path" to a lot of functions, only because an email message that the functions _may_ call may need to access that variable. If I made `lib_emailer.py` contain a class instead of separate functions, I could instantiate it early in auto-updater, populate the necessary attributes as the environmental-check proceeds. Then I could pass the emailer to the functions that might need to email. That feels more logical.  


- todos
    - set log-level from envar
    - [issues-link](https://github.com/Brown-University-Library/requirements-auto-updater/issues)

---